# debate-judge ロードマップ

## 完了

### 評価エンジンの再設計
- [x] 評価基準を「根拠の有無」から「論理構造の妥当性」に転換
- [x] 2パスアーキテクチャ（Pass1: AI検出、Pass2: コード算出）
- [x] 詭弁の体系化と重度別ペナルティ（致命的-5、重度-3、軽度-2）
- [x] GPT-4o-mini → GPT-4o へのモデルアップグレード
- [x] 構造化された詭弁検出（FallacyEntry型）

## コスト制御基盤

APIコストを予測可能にするための制限機構。
全ての制限値はルーム作成時にsettingsとして設定可能にする（constants.tsにデフォルト値）。

### 議論ルールの設定化
すべてDebateSettings型 + constants.tsのデフォルト値として管理する。
ルーム作成UIから変更可能にする。

| 設定項目 | デフォルト値 | 説明 |
|----------|------------|------|
| 設定項目 | デフォルト値 | 説明 |
|----------|------------|------|
| max_char_per_message | 200 | 1発言あたりの最大文字数（人間・AI共通） |
| turn_time_limit | 60 | 1発言あたりの持ち時間（秒） |
| max_comments | 10 | 各プレイヤーの最大発言数（計20メッセージ） |
| time_limit | 600 | 議論全体の制限時間（秒） |

コスト概算（AI対戦・最悪ケース）: **約$0.27/議論（約40円）**

### 文字数制限（max_char_per_message）
- [ ] constants.tsにMAX_CHAR_PER_MESSAGE=200を追加
- [ ] DebateSettings型にmax_char_per_messageを追加
- [ ] MessageInput UIに文字数カウンター＋入力制限を追加
- [ ] evaluate API側でバリデーション（超過時はリジェクト）
- [ ] AI応答生成のslice制限をsettings値に連動

### ターン制（交互発言の強制）
- [ ] 発言後、相手の返答があるまで送信ボタンを無効化
- [ ] API側で連続投稿をブロック（最新メッセージのuser_idが自分なら拒否）
- [ ] AI対戦時は自動的にターンが切り替わるため既存フローと整合

### 発言持ち時間（turn_time_limit）
- [ ] constants.tsにTURN_TIME_LIMIT=60を追加
- [ ] DebateSettings型にturn_time_limitを追加
- [ ] 発言ごとのカウントダウンタイマーをUIに表示
- [ ] 持ち時間超過時の処理を決定（自動パス or 強制終了）

### ターン数制限（max_comments）
- [ ] デフォルトを30→10に変更（無駄な発言の機会を減らし、発言の質を上げる）
- [ ] ルーム作成UIから変更可能にする

### 全体時間制限（time_limit）
- [ ] 現状: time_limit=600秒（クライアント依存）
- [ ] サーバー側タイマーでの終了処理の信頼性向上

### トークン量制御
- [ ] メッセージ数増加に伴うプロンプトのトークン膨張を抑制
  - 全メッセージ再評価 vs 直近N件のみ評価のトレードオフ検討
  - 要約ウィンドウ方式（古いメッセージを要約して圧縮）
- [ ] max_tokensの動的調整（メッセージ数に応じて）

### コスト見積もり表示
- [ ] ルーム作成画面に設定値に基づくコスト概算を表示
- [ ] 最悪ケース: ターン数 × 2(評価) × トークン単価

## 評価品質の改善

### 加点理由のenum化
- [ ] 自由記述 → 定義済みリストからの選択式に変更
- [ ] calculateScoreのマッチ精度向上

### 対等な議題でのテスト
- [ ] 双方に正当な論拠がある議題で評価の公平性を検証
- [ ] 詭弁が少ない健全な議論でのスコアリング妥当性確認

## マネタイズ（公開前に必須）

ユーザー数に比例してAPIコストが増加するため、公開前にコスト回収の仕組みが必要。
1議論あたりの原価: 約$0.27（約40円）。最低でもこれを回収する設計にする。

### 課金モデル: フリーミアム + クレジット制
- [ ] 無料枠: 1日1議論（初回障壁を潰す）
- [ ] 追加分: クレジット購入（1議論50-100円、原価40円+マージン）
- [ ] 判断基準: 無料枠しか使われなければサービスの価値が不足。それで終了で良い

### ユーザー獲得フロー
- ゲストアカウントでの議論はブラウザでは制限回避が容易なため不採用
  （localStorage/セッションは削除可能、フィンガープリント/IP制限も信頼性不足）
- [ ] 質の高い議論を非会員にも公開（観戦による集客）
  - 高スコア・詭弁が少ない議論をピックアップして公開
  - 閲覧は無料、議論参加は登録必須
  - 「読んで面白い」→ 登録 → 無料枠で体験 → クレジット購入 の導線
- [ ] 無料枠の管理はメールアドレス（Supabase Auth）単位で制御

### 決済基盤
- [ ] 決済サービスの選定（Stripe等）
- [ ] ユーザーごとの利用量トラッキング
- [ ] 無料枠の管理（日次リセット）
- [ ] 課金状態に応じたAPI呼び出し制御（残高不足時はブロック）

### 原価管理
- [ ] 1議論あたりの実コストをログに記録（トークン使用量ベース）
- [ ] 設定値（ターン数・文字数）から概算コストを事前計算
- [ ] コスト上限アラート（月間のAPI費用が閾値を超えたら通知）

## 将来の検討事項

- [ ] AI対戦相手の応答品質向上（ループ回避、多様な論法）
- [ ] 評価モデルの選択肢追加（Claude等）
- [ ] 観戦者向けリアルタイム評価解説
- [ ] ユーザーの議論傾向分析（tendency機能）
