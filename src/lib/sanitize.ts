/**
 * ユーザー入力のサニタイズ
 * プロンプトインジェクション的なパターンを無害化する
 *
 * 構造的限界: LLMへのプロンプトインジェクションはサニタイズで完全には防げない。
 * これは既知パターンの緩和であり、防御の本質はPass 2（コードスコア算出）と検出累積にある。
 */
export function sanitizeContent(content: string): string {
  return content
    // 改行を除去（偽メッセージ注入防止：プロンプト内の対話フォーマットを模倣させない）
    .replace(/[\r\n]+/g, " ")
    // マークダウンの強調記法を除去（**太字**、__太字__）
    .replace(/\*{1,3}([^*]*)\*{1,3}/g, "$1")
    .replace(/_{1,3}([^_]*)_{1,3}/g, "$1")
    // マークダウン見出し記法を除去
    .replace(/^#{1,6}\s*/gm, "")
    // プロンプト内の対話フォーマット模倣を除去（"1. [Player1]" 等）
    .replace(/\d+\.\s*\[Player[12]\]/gi, "[発言: $&]")
    // プロンプト内のセクション区切り模倣を除去（"■" "【" "】"）
    .replace(/[■【】]/g, "")
    // 「システム」「指示」「命令」等を装うパターンをエスケープ
    .replace(/システム(指示|命令|メッセージ|プロンプト)/g, "[発言: $&]")
    .replace(/system\s*(instruction|message|prompt|command)/gi, "[発言: $&]")
    .replace(/ignore\s*(previous|above|all)/gi, "[発言: $&]")
    .replace(/(無視|忘れ|リセット).{0,5}(してください|しろ|せよ)/g, "[発言: $&]");
}
